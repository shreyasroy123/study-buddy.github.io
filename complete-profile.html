<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - NotesBuddy</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="loading-container" id="loadingContainer">
            <h2>Completing your profile...</h2>
            <div class="loader"></div>
            <p id="statusMessage">Setting up your account...</p>
        </div>
        
        <div class="success-container" id="successContainer" style="display:none;">
            <h2>Profile Created Successfully!</h2>
            <p>Your account has been verified and your profile has been set up.</p>
            <a href="index.html" class="btn">Go to Homepage</a>
        </div>
        
        <div class="error-container" id="errorContainer" style="display:none;">
            <h2>Something Went Wrong</h2>
            <p id="errorMessage">We couldn't complete your profile setup.</p>
            <a href="login.html" class="btn">Go to Login</a>
        </div>
    </div>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://irqmhamkeytbiobbraxh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycW1oYW1rZXl0YmlvYmJyYXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA4NTAxMjYsImV4cCI6MjA1NjQyNjEyNn0.nnSRe3Z1BiZjSOIgOzg3I8zv7TtUmei-bPAELw7eEl8';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const loadingContainer = document.getElementById('loadingContainer');
        const successContainer = document.getElementById('successContainer');
        const errorContainer = document.getElementById('errorContainer');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        async function completeProfile() {
            try {
                // Check if the user is authenticated following email verification
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('No active session. Please try logging in again.');
                }
                
                const user = session.user;
                statusMessage.textContent = "User verified, creating profile...";
                
                // Get data from localStorage (if available) or from user metadata
                let userData = null;
                let avatarUrl = null;
                
                try {
                    userData = JSON.parse(localStorage.getItem('pendingUserData') || '{}');
                    avatarUrl = localStorage.getItem('pendingAvatarUrl');
                } catch (e) {
                    console.warn('Could not parse stored user data');
                }
                
                const fullName = userData?.fullName || user.user_metadata?.full_name || user.email.split('@')[0];
                const phone = userData?.phone || user.user_metadata?.phone || '';
                
                if (!avatarUrl && userData?.hasAvatar) {
                    const { data: { publicUrl } } = supabaseClient.storage
                        .from('avatars')
                        .getPublicUrl(`${user.id}.jpg`);
                    avatarUrl = publicUrl;
                }
                
                statusMessage.textContent = "Creating profile...";
                
                // Call the PostgreSQL function to create the profile
                const { data, error } = await supabaseClient.rpc(
                    'create_profile_for_confirmed_user',
                    {
                        user_id: user.id,
                        user_full_name: fullName,
                        user_phone: phone,
                        user_avatar_url: avatarUrl
                    }
                );
                
                if (error) throw error;
                
                // Clean up localStorage
                localStorage.removeItem('pendingUserData');
                localStorage.removeItem('pendingUserId');
                localStorage.removeItem('pendingAvatarUrl');
                
                // Show success message
                loadingContainer.style.display = 'none';
                successContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error completing profile:', error);
                loadingContainer.style.display = 'none';
                errorContainer.style.display = 'block';
                errorMessage.textContent = `Error: ${error.message || 'Unknown error occurred'}`;
            }
        }
        
        // Run when page loads
        document.addEventListener('DOMContentLoaded', completeProfile);
    </script>
</body>
</html>